import google.generativeai as genai
import asyncio
import uuid
import os
import mimetypes
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters.command import Command

genai.configure(api_key="–í–ê–® GEMINI –¢–û–ö–ï–ù. –ü–û–õ–£–ß–ò–¢–¨ –ï–ì–û –ú–û–ñ–ù–û –í AI STUDIO")  # API –∫–ª—é—á gemini
model = genai.GenerativeModel("gemini-2.5-pro")  # –ó–∞–¥–∞–µ–º –º–æ–¥–µ–ª—å

TG_TOK = "TELEGRAM TOKEN –í–ê–®–ï–ì–û –ë–û–¢–ê. –ü–û–õ–£–ß–ò–¢–¨ –ï–ì–û –ú–û–ñ–ù–û –£ @BotFather"  # API —Ç–æ–∫–µ–Ω —Ç–≥ –±–æ—Ç–∞

bot = Bot(token=TG_TOK)
dp = Dispatcher()


@dp.message(Command("start"))  # –∫–æ–º–∞–Ω–¥–∞ /start
async def start_handler(msg: types.Message):
    await msg.reply("""
–ü—Ä–∏–≤–µ—Ç! –Ø –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–æ—Ç –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ò–ò –º–æ–¥–µ–ª–∏ "Gemini 2.5 Pro".
–î–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ä–∞–≤—å—Ç–µ —Å–≤–æ–µ –≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ.
–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É–¥—É –ª–∏ —è —Ä–∞–±–æ—Ç–∞—Ç—å –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ /setup@googlespeech_bot.
""")


@dp.message(
    Command("setup"), F.chat.type.in_({"group", "supergroup"})
)  # –ö–æ–º–∞–Ω–¥–∞ /setup –≤ –≥—Ä—É–ø–ø–µ –∏ —Å—É–ø–µ—Ä-–≥—Ä—É–ø–ø–µ
async def setup_handler(msg: types.Message):
    chat_id = msg.chat.id  # –ê–π–¥–∏ —á–∞—Ç–∞
    try:  # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ—Ç–∞ –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞
        member = await bot.get_chat_member(chat_id, user_id=bot.id)
    except Exception as e:  # –µ—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ
        return await msg.reply("–ù–µ —Å–º–æ–≥ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ—é —Ä–∞–±–æ—Ç—É. –û—à–∏–±–∫–∞: \n {}".format(e))
    if isinstance(
        member, (types.ChatMemberOwner, types.ChatMemberAdministrator)
    ):  # –µ—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∏–ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        await msg.reply(
            "–î–∞. –Ø –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∑–¥–µ—Å—å.\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ –∏–ª–∏ –≤–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ."
        )
    else:  # –∏–Ω–∞—á–µ
        await msg.reply(
            "–ù–µ—Ç, —è –Ω–µ —Å–º–æ–≥—É –∑–¥–µ—Å—å —Ä–∞–±–æ—Ç–∞—Ç—å.\n–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –≤—ã–¥–∞–π—Ç–µ –º–Ω–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –≠—Ç–æ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —è –º–æ–≥ –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥."
        )


@dp.message(Command("setup"))  # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –≤ –≥—Ä—É–ø–ø–µ –∏–ª–∏ –≤ —Å—É–ø–µ—Ä-–≥—Ä—É–ø–ø–µ
async def setupnogroup_handler(msg: types.Message):
    await msg.reply(
        "–≠—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≥—Ä—É–ø–ø –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø. –ê —ç—Ç–æ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.\n–í –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –±—É–¥–µ—Ç –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, —á—Ç–æ –±–æ—Ç –∞–∫—Ü–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≥—Ä—É–ø–ø–∞—Ö."
    )


# @dp.message(F.reply_to_message, F.text.lower() == "—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É", F.reply_to_message.content_type.in_({'voice', 'video_note'}))
@dp.message(F.content_type.in_({"voice", "video_note"}))  # –¢–æ–ª—å–∫–æ –≥—Å –∏ –≤–∏–¥–µ–æ–∑–∞–º–µ—Ç–∫–∞
async def transcribe_handler(msg: types.Message):
    try:
        await msg.react(
            [types.ReactionTypeEmoji(emoji="üëç")]
        )  # –µ—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—Å—è —Å—Ç–∞–≤–∏–º —ç–º–æ–¥–∑–∏
    except:
        await msg.reply(
            "–°–µ–∫—É–Ω–¥–æ—á–∫—É...\nP.S. –í—ã–¥–∞–π—Ç–µ –º–Ω–µ –ø—Ä–∞–≤–æ —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏. –° –Ω–∏–º —è –Ω–µ –±—É–¥—É –∑–∞—Å–æ—Ä—è—Ç—å —á–∞—Ç —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º."
        )  # –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —É–ø–æ–º–∏–Ω–∞–µ–º
    try:
        if msg.voice:  # –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ - –≥–æ–ª–æ—Å–æ–≤–æ–µ
            file_id = msg.voice.file_id  # –∞–π–¥–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            file_ext = ".mp3"  # –Ω–∞ –±—É–¥—É—â–µ–µ –∑–∞–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
        else:  # –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫–æ–π –ª–∏–±–æ –¥—Ä—É–≥–æ–π —Ç–∏–ø(–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –∫—Ä—É–∂–æ–∫)
            file_id = msg.video_note.file_id  # –∞–π–¥–∏
            file_ext = ".mp4"  # —Ñ–æ—Ä–º–∞—Ç
        file = await bot.get_file(file_id)  # –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∞–π–ª
        path = file.file_path  # –ø–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å —Ñ–∞–π–ª–∞
        filpath = (
            str(msg.message_id) + file_ext
        )  # —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø—É—Ç—å –∫—É–¥–∞ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ –ø–∫
        await bot.download_file(path, filpath)  # —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ

        # –í—Å–µ —á—Ç–æ –¥–∞–ª–µ–µ - –≤–∑—è—Ç–æ —Å —Ñ–æ—Ä—É–º–∞
        mime_type, _ = mimetypes.guess_type(filpath)
        if mime_type is None:
            mime_type = "application/octet-stream"

        with open(filpath, "rb") as f:
            audio_bytes = f.read()

        audio_file_part = {"mime_type": mime_type, "data": audio_bytes}
        # –∫–æ–Ω—á–∞–µ—Ç—Å—è
        # –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        prompt = {
            ".mp3": "–ù–∞–ø–∏—à–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É —ç—Ç–æ–≥–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤. –¢–∞–∫–∂–µ –º–æ–∂–µ—à—å –æ–ø–∏—Å—ã–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏, –∑–≤—É–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ –∏ —Ç.–¥. –¢–∞–π–º–∫–æ–¥—ã –ø–∏—Å–∞—Ç—å –Ω–µ –Ω–∞–¥–æ. –¢–∞–∫–∂–µ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞",
            ".mp4": "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É —Ç–æ–≥–æ —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—Å—è –≤ —ç—Ç–æ–º –≤–∏–¥–µ–æ, –ø–æ—Ç–æ–º –ø—Ä–æ–ø—É—Å—Ç–∏–≤ —Å—Ç—Ä–æ–∫—É –æ–ø–∏—à–∏ —á—Ç–æ –≤ –Ω–µ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –Ω–æ –∫—Ä–∞—Ç–∫–æ. –ü–æ –ø–æ–≤–æ–¥—É —Ä–µ—á–∏ - —Ç–∞–∫ –∂–µ –º–æ–∂–µ—à—å –æ–ø–∏—Å—ã–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏, –∑–≤—É–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ –∏ —Ç.–¥. –¢–∞–π–º–∫–æ–¥—ã –ø–∏—Å–∞—Ç—å –Ω–µ –Ω–∞–¥–æ. –¢–∞–∫–∂–µ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞. –í–∏–¥–µ–æ –∫—Ä—É–≥–ª–æ–µ –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ —Å–∫–∞—á–∞–Ω–Ω—ã–π –∫—Ä—É–∂–æ–∫ –∏–∑ —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞, –Ω–µ —É–ø–æ–º–∏–Ω–∞–π —ç—Ç–æ.",
        }
        description = await model.generate_content_async(
            [prompt[file_ext], audio_file_part]
        )  # –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–µ–π—Ä–æ–Ω–∫–∏
        await msg.reply(description.text)  # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        os.remove(filpath)  # —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    except Exception as e:  # –ø—Ä–æ–≤–∞–ª –≤ –∫–∞–∫–æ–π —Ç–æ —á–∞—Å—Ç–∏ –∫–æ–¥–∞
        await msg.reply("–ß—Ç–æ —Ç–æ –Ω–µ –≤—ã—à–ª–æ.\n{}".format(e))  # –°–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ


async def boot():
    await dp.start_polling(bot)  # –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–æ—Ç


if __name__ == "__main__":
    asyncio.run(boot())  # —Å –ø–æ–º–æ—â—å—é asyncio —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ
